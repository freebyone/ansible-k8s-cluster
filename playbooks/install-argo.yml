---
- hosts: kube_control_plane[0]
  become: yes
  vars:
    argo_cd_namespace: argocd
    argo_cd_version: v2.12.0
    argo_cd_helm_repo: https://argoproj.github.io/argo-helm
  tasks:
    - name: Add Argo Helm repo
      kubernetes.core.helm_repository:
        name: argo
        repo_url: "{{ argo_cd_helm_repo }}"

    - name: Install Argo CD via Helm
      kubernetes.core.helm:
        name: argocd
        chart_ref: argo/argo-cd
        chart_version: "{{ argo_cd_version }}"
        release_namespace: "{{ argo_cd_namespace }}"
        create_namespace: true
        values:
          server:
            ingress:
              enabled: true
              hosts:
                - "{{ domain_argo_link }}"
          redis:
            enabled: true

    - name: Get Argo CD initial password
      command: kubectl -n {{ argo_cd_namespace }} get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d
      register: argo_password
      changed_when: false

    - name: Display Argo CD password
      debug:
        msg: "Argo CD admin password: {{ argo_password.stdout }}"